

var PodComms = require('PodComms');
var _ = require('underscore');
var fs = require('fs');

Array.splat = function (obj) {
	return _.isArray(obj) ? obj : [obj];
}

var randGifFile = 'gif.json';
var gifCategoryList = [];
var gifCategoryListIndex = [];

var check = function(user, msg, match, callback){
	if (!gifCategoryList || gifCategoryList.length == 0) {
		reloadGifs(user, msg, match, callback);
		return true;
	}
	return false;
}

var gif = function(user, msg, match){
	if( check(user, msg, match, gif) ) return;
	
	if (match.length > 1 && match[1].length > 0) {
		var name = match[1];

		// for each category
		var category = gifCategoryListIndex[name.toLowerCase()];

		if (category) {
			return '<i>'+ category.name + '</i><br />' + category.urls[_.random(0, category.urls.length-1)];
		}

		PodComms.Message.private('Can\'t find category '+name, user);
		return;
	}

	PodComms.Message.private('I need a gif category name...', user);
}

var giflist = function(user, msg, match){
	if( check(user, msg, match, giflist) ) return;

	var list = [];
	_.each( gifCategoryList, function(category){
		var text = '<b>'+category.name+'</b> synonyms:<code>' + Array.splat( category.synonyms ).join('</code><code>')+'</code>';
		this.push(text);
	},list);

	PodComms.Message.private('Random gif list:<br /><ul><li>'+list.join('</li><li>')+'</li></ul>', user);
}

function reloadGifs (user, msg, match, callback) {
	fs.readFile(randGifFile, function (err, data) {
		if (err) {
			PodComms.Message.private('read fail:'+err, user);
			PodComms.Logger.error( err );
			return;
		}

		if (data && data.length) {
			gifCategoryList = JSON.parse( data );

			// Build index
			gifCategoryListIndex = [];
			_.each( gifCategoryList, function(category){

				_.each( Array.splat( category.synonyms ), function(synonym){

					gifCategoryListIndex[synonym.toLowerCase()] = this;

				}, category);
			});

			if (callback) {
				callback(user, msg, match);
			} else {
				PodComms.Message.private('Loaded '+ gifCategoryList.length +' gif categories from file');
			}

			PodComms.Logger.info('Loaded '+ gifCategoryList.length +' gif categories from file');
		} else {
			PodComms.Logger.error('Error loading, read the logs');
		}
	});
}

PodComms.Command.register('gif', {
	description: 'Sends out a random gif from a given category',
	example: '/gif lol',
	callback: gif
});

PodComms.Command.register('giflist', {
	description: 'List all gif categories', 
	callback: giflist
});

PodComms.Command.register('gifreload', {
	description: 'Force reload gifs from file', 
	callback: reloadGifs
});