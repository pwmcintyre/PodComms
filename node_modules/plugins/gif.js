

var PodComms = require('PodComms');
var _ = require('underscore.js');
var fs = require('fs');

Array.splat = function (obj) {
	return _.isArray(obj) ? obj : [obj];
}



var randGifFile = 'gif.json';
var gifCategoryList = [];
var gifCategoryListIndex = [];

function reloadGifs (user) {
	fs.readFile(randGifFile, function (err, data) {
		if (err) {
			PodComms.Messaging.private('read fail:'+err, user);
			console.log( err );
			return;
		}

		if (data && data.length) {
			data = JSON.parse( data );

			gifCategoryList = data;

			// Build index
			gifCategoryListIndex = [];
			_.each( gifCategoryList, function(category){

				_.each( Array.splat( category.synonyms ), function(synonym){

					gifCategoryListIndex[synonym.toLowerCase()] = this;

				}, category);
			});

			console.log('Loaded '+ gifCategoryList.length +' gif categories from file');
		} else {
			if (user)
				PodComms.Messaging.private('Error loading, read the logs', user);
		}
	});
}
reloadGifs();

PodComms.Command.register('gifreload', {
	description: 'Force reload gifs from file', 
	callback: function(user, msg, match){
		reloadGifs(user);
	}
});

PodComms.Command.register('giflist', {
	description: 'List all gif categories', 
	callback: function(user, msg, match){
		if (!gifCategoryList || gifCategoryList.length == 0) {
			reloadGifs(user);
			PodComms.Messaging.private('No gifs found.... I\'ll try reload them, ask me again', user);
			return;
		}

		var list = [];
		_.each( gifCategoryList, function(category){
			var text = '<b>'+category.name+'</b> synonyms:<code>' + Array.splat( category.synonyms ).join('</code><code>')+'</code>';
			this.push(text);
		},list);

		PodComms.Messaging.private('Random gif list:<br /><ul><li>'+list.join('</li><li>')+'</li></ul>', user);
	}
});

PodComms.Command.register('gif', {
	description: 'Sends out a random gif from a given category',
	example: '/gif lol',
	callback: function(user, msg, match){
		if (!gifCategoryList || gifCategoryList.length == 0)
			reloadGifs(user);
		
		if (match.length > 1 && match[1].length > 0) {
			var name = match[1];

			// for each category
			var category = gifCategoryListIndex[name.toLowerCase()];

			if (category) {
				return '<i>'+ category.name + '</i><br />' + category.urls[_.random(0, category.urls.length-1)];
			}

			PodComms.Messaging.private('Can\'t find category '+name, user);
			return;
		}

		PodComms.Messaging.private('I need a gif category name...', user);
	}
});